<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>La Gang dei Richiardi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

    <style>
        /* Variabili di base */
        :root {
            --primary: #D62828; 
            --secondary: #008000; 
            --text-dark: #2c3e50; 
            --text-light: white; 
            --muted-light: #cccccc; 
            --background-dark: #1c1c1c; 
            --card-dark: #2c2c2c; 
            --ad-background: #f0f0f0; 
            --ad-border: #aaaaaa;
            --ad-text-dark: #333333;
            --ad-text-muted: #666666;
            --ios-blue: #007AFF;
            --ios-gray-bubble: #3a3a3c;
            --red-button: #D62828; /* Usato per il bottone Rimuovi Annunci */
        }

        /* --- CONTROLLO SCROLLBAR E LAYOUT APP --- */
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden; 
            -ms-overflow-style: none;
            scrollbar-width: none;
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-dark);
            user-select: none;
            -webkit-user-select: none;
        }

        body::-webkit-scrollbar { display: none; }

        #app-content-wrapper {
            position: fixed;
            top: 44px; 
            bottom: 60px; 
            left: 0;
            right: 0;
            width: 100%;
            overflow-y: auto; 
            overflow-x: hidden;
            background-color: var(--background-dark); 
        }

        /* --- NAV BAR --- */
        #navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* Modifica: per spazio al bottone */
            padding: 0 15px; /* Modifica: per spazio al bottone */
            background-color: rgba(44, 44, 44, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 20; 
        }

        #navbar h1 {
            font-size: 1.1rem;
            color: var(--text-light);
            font-weight: 600;
            margin: 0;
            flex-grow: 1; 
            text-align: center; 
        }
        
        /* Nuovo Bottone Rimuovi Annunci */
        #removeAdsBtn {
            background-color: var(--red-button);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.2s;
            white-space: nowrap; 
        }

        #removeAdsBtn:hover {
            background-color: #a02020;
        }
        
        /* Nasconde il titolo quando il bottone Ã¨ attivo su schermi piccoli */
        @media (max-width: 480px) {
             #navbar h1 {
                 font-size: 1rem;
             }
        }


        #main-content-simulator {
            padding: 20px;
            text-align: center;
            padding-bottom: 0; 
            padding-top: 0;
        }

        h2, h3 { color: var(--text-light); }

        /* --- SEZIONI --- */
        #channel-description, #giveaway-section {
            width: 90%;
            max-width: 600px;
            margin: 40px auto; 
            text-align: left;
            padding: 20px;
            background-color: var(--card-dark); 
            border-radius: 30px; 
            box-shadow: none; 
            line-height: 1.6;
        }
        
        /* ... (altri stili sezione/tabelle invariati) ... */
        
        #channel-description p, #giveaway-section p {
            margin-bottom: 15px;
            font-size: 1rem;
            color: var(--muted-light); 
        }
        
        #giveaway-section h2 {
            font-size: 1.5rem;
            color: var(--text-light);
            margin-top: 0;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
            text-align: center;
        }

        /* --- NUOVA SEZIONE COLLAB E ADMIN --- */
        #collab-admin-section {
            width: 90%;
            max-width: 600px;
            margin: 20px auto;
            text-align: left;
        }

        #collab-admin-section h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            margin-left: 10px;
            color: var(--muted-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ios-table {
            background-color: var(--card-dark);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid white; 
            margin-bottom: 30px; 
        }

        .ios-row {
            padding: 15px 20px;
            color: var(--text-light);
            font-size: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
        }

        .ios-row:last-child {
            border-bottom: none;
        }
        
        /* --- STILI BANNER (Annunci) - INVARIATI --- */
        .ad-banner {
            background-color: var(--ad-background); 
            border: 1px solid var(--ad-border);
            z-index: 15;
            display: none; 
            box-shadow: none;
            align-items: stretch;
            overflow: hidden;
            position: relative; 
        }

        .ad-link-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            text-decoration: none; 
            color: inherit; 
            cursor: pointer;
            min-width: 0;
            position: relative; 
        }

        .ad-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            justify-content: center; 
            word-wrap: break-word; 
        }
        
        .ad-image {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            position: absolute;
            top: 0;
            left: 0;
            display: none; 
        }

        #stickyAdImage {
            height: 100%; 
            width: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            display: none; 
        }
        
        #stickyAdBanner.image-ad #stickyAdContent { display: none; }
        #stickyAdBanner.image-ad #stickyAdImage { display: block; margin: 0; height: 100%; width: 100%; object-fit: cover; position: absolute; }
        #stickyAdBanner.image-ad .ad-link-wrapper { justify-content: flex-start; align-items: center; padding: 0; }
        #stickyAdBanner.image-ad { padding: 0; }
        #stickyAdBanner.image-ad .ad-controls { z-index: 2; }
        
        .ad-title {
            font-weight: 600;
            color: var(--ad-text-dark); 
            overflow-wrap: break-word; 
            white-space: normal; 
        }
        
        .ad-description {
            color: var(--ad-text-muted); 
            overflow-wrap: break-word; 
            white-space: normal; 
        }
        
        .ad-controls {
            position: absolute;
            top: 0; 
            right: 0; 
            height: auto; 
            display: flex;
            align-items: flex-start; 
            justify-content: flex-end; 
            gap: 1px; 
            flex-shrink: 0;
            padding: 0; 
            z-index: 16; 
        }
        
        .ad-control-btn {
            background: white; 
            border: none;
            padding: 0; 
            cursor: pointer;
            width: 18px; 
            height: 18px;
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-radius: 0; 
            box-shadow: none; 
            transition: background-color 0.1s;
        }

        .ad-control-btn i.fa-ellipsis-v {
            color: #0AADCC; 
            font-size: 1rem; 
        }
        
        .ad-control-btn:hover { background-color: var(--ad-border); }
        .ad-control-btn img { width: 80%; height: 80%; object-fit: contain; }
        
        .ad-info-text-container {
            display: none; 
            flex-grow: 1;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            min-width: 0;
        }

        .ad-info-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--ad-text-dark);
            text-align: center;
            width: 100%;
            padding-left: 30px; 
        }

        .ad-back-arrow {
            position: absolute;
            top: 50%;
            left: 8px;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 5px 8px;
            cursor: pointer;
            display: none; 
            z-index: 17;
            color: var(--ad-text-dark); 
        }
        .ad-back-arrow i { font-size: 1.2rem; }
        .ad-link-wrapper.hidden-content { display: none !important; }

        /* --- BANNER SPECIFICI --- */
        #stickyAdBanner {
            position: fixed; 
            bottom: 0px; 
            left: 0; 
            right: 0;
            width: 100%; 
            height: 60px; 
            border-radius: 0; 
            border-top: 1px solid var(--ad-border); 
            padding: 5px 0; 
            z-index: 20; 
        }
        #stickyAdBanner .ad-link-wrapper { padding-right: 70px; }
        #stickyAdBanner .ad-content { padding-left: 10px; }
        #stickyAdBanner .ad-title { font-size: 0.9rem; }
        #stickyAdBanner .ad-description { font-size: 0.7rem; }

        /* Annunci 250x250 (Inline e Middle) */
        #inlineAdBanner, #middleAdBanner {
            display: flex;
            width: 250px;
            height: 250px; 
            margin: 20px auto; 
            flex-direction: column; 
            padding: 5px; 
            border-radius: 0; 
        }
        #inlineAdBanner .ad-link-wrapper, #middleAdBanner .ad-link-wrapper {
            flex-direction: column; 
            justify-content: center;
            text-align: center;
            padding-right: 0;
            flex-grow: 1;
        }
        #inlineAdBanner .ad-controls, #middleAdBanner .ad-controls { top: 0; right: 0; height: auto; padding: 0; }
        #inlineAdBanner .ad-content, #middleAdBanner .ad-content { padding: 10px; flex-grow: 1; }
        #inlineAdBanner.image-ad, #middleAdBanner.image-ad { padding: 0; }
        #inlineAdBanner.image-ad .ad-link-wrapper, #middleAdBanner.image-ad .ad-link-wrapper { padding: 0; }
        #inlineAdBanner.image-ad .ad-content, #middleAdBanner.image-ad .ad-content { display: none; }
        #inlineAdBanner .ad-title, #middleAdBanner .ad-title { font-size: 1rem; }
        #inlineAdBanner .ad-description, #middleAdBanner .ad-description { font-size: 0.8rem; margin-top: 5px; }
        #inlineAdBanner .ad-info-text, #middleAdBanner .ad-info-text { font-size: 0.8rem; padding-left: 0; margin-top: 30px; }
        
        /* --- NUOVI STILI POP-UP (180x150) - INVARIATI --- */
        #popupAdBanner {
            position: fixed;
            right: -180px; 
            bottom: 120px; 
            width: 180px; 
            height: 150px; 
            border-radius: 0; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: none; 
            z-index: 150; 
            flex-direction: column; 
            padding: 5px; 
            transition: right 0.5s ease-in-out, opacity 0.5s ease-in-out; 
        }

        #popupAdBanner.image-ad { padding: 0; }
        #popupAdBanner.image-ad .ad-link-wrapper { padding: 0; }
        #popupAdBanner.image-ad .ad-content { display: none; }
        #popupAdBanner.show { right: 20px; opacity: 1; }
        #popupAdBanner.hide { right: -180px; opacity: 0; }
        #popupAdBanner .ad-link-wrapper { flex-direction: column; justify-content: center; text-align: center; padding-right: 0; flex-grow: 1; }
        #popupAdBanner .ad-controls { top: 0; right: 0; height: auto; padding: 0; }
        #popupAdBanner .ad-content { padding: 10px; flex-grow: 1; }
        #popupAdBanner .ad-title { font-size: 0.8rem; font-weight: 700; }
        #popupAdBanner .ad-description { font-size: 0.65rem; margin-top: 3px; }
        #popupAdBanner .ad-info-text { font-size: 0.8rem; padding-left: 0; margin-top: 30px; }


        /* --- AI CHAT E FLOATING BUTTON - INVARIATI --- */
        #ai-fab {
            position: fixed;
            bottom: 75px; 
            right: 20px;
            width: 55px;
            height: 55px;
            background-color: var(--ios-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 100;
            color: white;
            font-size: 1.5rem;
            transition: transform 0.2s;
        }
        #ai-fab:active { transform: scale(0.95); }

        #chat-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        #chat-container {
            width: 90%;
            max-width: 400px;
            height: 80%;
            background-color: #1c1c1e; 
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        #chat-header {
            padding: 15px;
            background-color: #2c2c2e;
            color: white;
            text-align: center;
            font-weight: 600;
            border-bottom: 1px solid #3a3a3c;
            position: relative;
        }

        #chat-close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 1rem;
            cursor: pointer;
        }

        #chat-messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.ai {
            background-color: var(--ios-gray-bubble);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .message.user {
            background-color: var(--ios-blue);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        #chat-input-area {
            padding: 10px;
            background-color: #2c2c2e;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #chat-input {
            flex-grow: 1;
            background-color: #1c1c1e;
            border: 1px solid #3a3a3c;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-family: inherit;
        }
        #chat-input:focus { outline: none; border-color: var(--ios-blue); }

        #chat-send-btn {
            background: none;
            border: none;
            color: var(--ios-blue);
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* --- BOTTOM SHEET MODAL (Rimuovi Annunci) --- */
        #bottomSheetModal {
            position: fixed;
            bottom: -100%; 
            left: 0;
            width: 100%;
            height: auto;
            max-height: 80%;
            background-color: var(--card-dark);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
            z-index: 300;
            transition: bottom 0.3s ease-out;
            padding: 20px;
            box-sizing: border-box;
            color: var(--text-light);
            display: none; 
            flex-direction: column;
            font-family: 'Poppins', sans-serif;
        }

        #bottomSheetModal.visible {
            bottom: 0;
        }
        
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 299;
            display: none;
        }

        .bottom-sheet-header {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .bottom-sheet-description {
            font-size: 0.9rem;
            color: var(--muted-light);
            margin-bottom: 20px;
            text-align: center;
        }

        .bottom-sheet-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .bottom-sheet-input {
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--muted-light);
            background-color: var(--background-dark);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
        }

        #validateKeyBtn {
            background-color: var(--ios-blue);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Poppins', sans-serif;
        }

        #validateKeyBtn:hover {
            background-color: #0060e0;
        }

        #validationMessage {
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
            min-height: 20px;
        }

        /* --- MEDIA QUERY PER DESKTOP/SCHERMI LARGHI --- */
        @media (min-width: 768px) {
            #app-content-wrapper {
                left: 50%; 
                transform: translateX(-50%); 
                width: 100%;
                max-width: 1024px; /* Simula una larghezza massima per desktop */
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }

            #navbar {
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
                max-width: 1024px;
            }
            
            #stickyAdBanner {
                left: 50%;
                transform: translateX(-50%);
                max-width: 1024px;
            }
            
            #ai-fab {
                 right: calc(50% - 1024px/2 + 20px); /* Posiziona il FAB correttamente a destra */
            }

            #bottomSheetModal {
                left: 50%; 
                transform: translateX(-50%); 
                max-width: 1024px;
                border-left: 1px solid rgba(255, 255, 255, 0.1);
                border-right: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* Sposta gli annunci 250x250 ai lati */
            .ad-container-desktop {
                position: fixed;
                top: 54px; /* Sotto la navbar */
                bottom: 70px; /* Sopra la sticky ad */
                width: calc(50% - 512px); /* Spazio a lato del contenuto principale */
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding-top: 20px;
            }
            
            #leftAdContainer {
                left: 0;
            }
            
            #rightAdContainer {
                right: 0;
            }
            
            /* Nasconde gli annunci inline nel contenuto se visualizzati ai lati */
            #inlineAdBanner, #middleAdBanner {
                display: none !important;
            }
            
            /* Se un annuncio Ã¨ disabilitato, non visualizziamo i contenitori a lato */
            .ad-container-desktop.hidden-ads {
                display: none;
            }
            
            /* Forziamo gli annunci 250x250 nel contenitore laterale */
             .ad-container-desktop #inlineAdBanner,
             .ad-container-desktop #middleAdBanner {
                 display: flex !important;
             }
        }
        
        /* Regola l'altezza della wrapper quando non c'Ã¨ la sticky ad */
        .ads-removed #app-content-wrapper {
            bottom: 0px; 
        }

        /* Regola la posizione del FAB quando non c'Ã¨ la sticky ad */
        .ads-removed #ai-fab {
             bottom: 20px;
        }
        
    </style>
</head>
<body class="ads-enabled">

<div id="overlay"></div>

<nav id="navbar">
    <button id="removeAdsBtn">RIMUOVI ANNUNCI</button>
    <h1>La Gang Dei Richiardi</h1>
</nav>

<div id="leftAdContainer" class="ad-container-desktop hidden-ads">
    </div>
<div id="rightAdContainer" class="ad-container-desktop hidden-ads">
    </div>
<div id="app-content-wrapper">
    <div id="main-content-simulator">
        
        <div id="channel-description">
            <p>
                Benvenuti sul canale La Gang dei Richiardi. 
                Le nostre collaborazioni principali sono con Dive e Dark.
                Qui vedrete video di vita quotidiana, challenge epiche insieme al club delle dive, che Ã¨ una collaborazione ufficiale.
            </p>
            <p>
                Ci saranno anche edit, in ricordo di hard edit, e video di giochi fatti insieme ai miei amici.
            </p>
            <p>
                Per maggiori info sul sito e per parlare con gli admin, scrivete al numero 351 850 1846.
                Speriamo che i contenuti vi piacciano e continuate a seguirci per non perdervi le prossime avventure!
            </p>
        </div>

        <div id="collab-admin-section">
            <h3>Admin</h3>
            <div class="ios-table">
                <div class="ios-row">Cristian</div>
                <div class="ios-row">Sergio</div>
            </div>

            <div style="height: 10px;"></div>

            <h3>Collab</h3>
            <div class="ios-table">
                <div class="ios-row">Dive</div>
                <div class="ios-row">Dark</div>
            </div>
        </div>
        
        <div id="middleAdBanner" class="ad-banner">
            <button id="middleAdBackArrow" class="ad-back-arrow" title="Go Back"><i class="fa-solid fa-arrow-left"></i></button>
            <a id="middleAdLink" class="ad-link-wrapper" href="#" target="_blank">
                <img id="middleAdImage" class="ad-image" src="" alt="Annuncio Immagine">
                <div id="middleAdContent" class="ad-content"> 
                    <div id="middleAdTitle" class="ad-title">Caricamento Annuncio...</div>
                    <div id="middleAdDescription" class="ad-description">Caricamento descrizione...</div>
                </div>
            </a>
            <div id="middleAdInfoTextContainer" class="ad-info-text-container">
                <div id="middleAdInfoText" class="ad-info-text">ADS By Dark</div>
            </div>
            <div id="middleAdControls" class="ad-controls">
                <button class="ad-control-btn" title="AdChoices" onclick="event.stopPropagation(); window.toggleAdInfoView('middle');">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/AdChoices_Icon.png" onerror="this.src='https://placehold.co/20x20/007bff/ffffff?text=Ad'" alt="AdChoices">
                </button>
                <button id="middleAdOptionsBtn" class="ad-control-btn" title="Options" onclick="event.stopPropagation(); window.toggleAdInfoView('middle');">
                    <i class="fa-solid fa-ellipsis-v"></i>
                </button>
            </div>
        </div>

        <div id="giveaway-section">
            <h2>Sala Giveaway Brainrot</h2>
            <p>
                Entrate nell'epicentro del "Brainrot" con i nostri giveaway esclusivi, dove la fortuna incontra l'assurdo!
            </p>
        </div>

        <div id="inlineAdBanner" class="ad-banner">
            <button id="inlineAdBackArrow" class="ad-back-arrow" title="Go Back"><i class="fa-solid fa-arrow-left"></i></button>
            <a id="inlineAdLink" class="ad-link-wrapper" href="#" target="_blank">
                <img id="inlineAdImage" class="ad-image" src="" alt="Annuncio Immagine">
                <div id="inlineAdContent" class="ad-content"> 
                    <div id="inlineAdTitle" class="ad-title">Caricamento Annuncio...</div>
                    <div id="inlineAdDescription" class="ad-description">Caricamento descrizione...</div>
                </div>
            </a>
            <div id="inlineAdInfoTextContainer" class="ad-info-text-container">
                <div id="inlineAdInfoText" class="ad-info-text">ADS By Dark</div>
            </div>
            <div id="inlineAdControls" class="ad-controls">
                 <button class="ad-control-btn" title="AdChoices" onclick="event.stopPropagation(); window.toggleAdInfoView('inline');">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/AdChoices_Icon.png" onerror="this.src='https://placehold.co/20x20/007bff/ffffff?text=Ad'" alt="AdChoices">
                </button>
                <button id="inlineAdOptionsBtn" class="ad-control-btn" title="Options" onclick="event.stopPropagation(); window.toggleAdInfoView('inline');">
                    <i class="fa-solid fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
    </div>
</div>

<div id="popupAdBanner" class="ad-banner hide">
    <button id="popupAdBackArrow" class="ad-back-arrow" title="Go Back"><i class="fa-solid fa-arrow-left"></i></button>
    <a id="popupAdLink" class="ad-link-wrapper" href="#" target="_blank">
        <img id="popupAdImage" class="ad-image" src="" alt="Annuncio Immagine Pop-up">
        <div id="popupAdContent" class="ad-content"> 
            <div id="popupAdTitle" class="ad-title">Caricamento Annuncio Pop-up...</div>
            <div id="popupAdDescription" class="ad-description">Caricamento descrizione pop-up...</div>
        </div>
    </a>
    <div id="popupAdInfoTextContainer" class="ad-info-text-container">
        <div id="popupAdInfoText" class="ad-info-text">ADS By Dark</div>
    </div>
    <div id="popupAdControls" class="ad-controls">
        <button class="ad-control-btn" title="AdChoices" onclick="event.stopPropagation(); window.toggleAdInfoView('popup');">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/AdChoices_Icon.png" onerror="this.src='https://placehold.co/20x20/007bff/ffffff?text=Ad'" alt="AdChoices">
        </button>
        <button id="popupAdOptionsBtn" class="ad-control-btn" title="Options" onclick="event.stopPropagation(); window.toggleAdInfoView('popup');">
            <i class="fa-solid fa-ellipsis-v"></i>
        </button>
    </div>
</div>

<div id="stickyAdBanner" class="ad-banner">
    <button id="stickyAdBackArrow" class="ad-back-arrow" title="Go Back"><i class="fa-solid fa-arrow-left"></i></button>
    <a id="stickyAdLink" class="ad-link-wrapper" href="#" target="_blank">
        <img id="stickyAdImage" src="" alt="Annuncio Banner"> 
        <div id="stickyAdContent" class="ad-content"> 
            <div id="stickyAdTitle" class="ad-title">Caricamento Annuncio...</div>
            <div id="stickyAdDescription" class="ad-description">Caricamento descrizione...</div>
        </div>
    </a>
    <div id="stickyAdInfoTextContainer" class="ad-info-text-container">
        <div id="stickyAdInfoText" class="ad-info-text">ADS By Dark</div>
    </div>
    <div id="stickyAdControls" class="ad-controls">
         <button class="ad-control-btn" title="AdChoices" onclick="event.stopPropagation(); window.toggleAdInfoView('sticky');">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/AdChoices_Icon.png" onerror="this.src='https://placehold.co/20x20/007bff/ffffff?text=Ad'" alt="AdChoices">
        </button>
        <button id="stickyAdOptionsBtn" class="ad-control-btn" title="Options" onclick="event.stopPropagation(); window.toggleAdInfoView('sticky');">
            <i class="fa-solid fa-ellipsis-v"></i>
        </button>
    </div>
</div>

<div id="ai-fab">
    <i class="fa-solid fa-robot"></i>
</div>

<div id="chat-modal">
    <div id="chat-container">
        <div id="chat-header">
            Assistente Collab
            <button id="chat-close-btn">Chiudi</button>
        </div>
        <div id="chat-messages">
            </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Scrivi un messaggio...">
            <button id="chat-send-btn"><i class="fa-solid fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<div id="bottomSheetModal">
    <div class="bottom-sheet-header">Rimuovi Annunci</div>
    <div class="bottom-sheet-description">
        Rimuovi tutti gli annunci con una chiave speciale e unica (non riusabile) per il periodo selezionato.
    </div>
    <div class="bottom-sheet-input-group">
        <input type="text" id="adsRemovalKeyInput" class="bottom-sheet-input" placeholder="Inserisci la chiave di rimozione annunci (es. 7D-...)">
    </div>
    <button id="validateKeyBtn">Applica Chiave</button>
    <div id="validationMessage"></div>
</div>

<script type="module">
    // --- 1. Firebase Imports (Invariati) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, onSnapshot, query, setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Polyfill per la funzione di hashing (semplice simulazione, non sicuro per produzione)
    // Nota: window.btoa Ã¨ un hash base64 standard, ma non Ã¨ una funzione hash sicura (SHA-256 ecc.).
    // Per una vera sicurezza, si dovrebbe usare un backend. Qui si usa solo per creare un token "strutturato".
    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0; // Convert to 32bit integer
        }
        return btoa(String(hash));
    }


    // --- 2. Firebase Config (Invariati) ---
    const userProvidedConfig = {
        apiKey: "AIzaSyBiDjwSktDSEdomaRnbfl1UcvCgihhWH1A", 
        projectId: "themoreinfoblog",
    };
    const firebaseConfig = { ...userProvidedConfig };
    
    const appId = 'default-app-id';
    const ADS_COLLECTION_PATH = `/artifacts/${appId}/public/data/ads`; 

    // --- 3. Variabili di Stato Ads ---
    let app, db, auth;
    let allAds = []; 
    let currentAd = {}; 
    let adsUnsubscribe = null; 
    let adRefreshTimers = {}; 
    
    // Stato Rimuovi Annunci
    const ADS_EXPIRY_KEY = 'ads_removal_expiry';
    let adsRemovedExpiry = localStorage.getItem(ADS_EXPIRY_KEY) ? new Date(localStorage.getItem(ADS_EXPIRY_KEY)) : null;

    // Funzione di utilitÃ  per verificare lo stato degli annunci
    function isAdsEnabled() {
        if (!adsRemovedExpiry || adsRemovedExpiry <= new Date()) {
            // Se la data non Ã¨ impostata o Ã¨ scaduta
            document.body.classList.remove('ads-removed');
            document.body.classList.add('ads-enabled');
            return true;
        }
        // Se la data Ã¨ valida e nel futuro
        document.body.classList.remove('ads-enabled');
        document.body.classList.add('ads-removed');
        return false;
    }
    
    // Funzione per nascondere tutti i banner
    function hideAllAds() {
        Object.values(elements).forEach(el => {
            if (el.banner) {
                el.banner.style.display = 'none';
                // Pulisce i timer di refresh
                if (el.banner.id !== 'popupAdBanner' && adRefreshTimers[el.banner.id.replace('AdBanner', '')]) {
                    clearTimeout(adRefreshTimers[el.banner.id.replace('AdBanner', '')]);
                }
            }
        });
        // Disabilita i contenitori desktop
        document.getElementById('leftAdContainer').classList.add('hidden-ads');
        document.getElementById('rightAdContainer').classList.add('hidden-ads');
        
        // Ferma il ciclo del pop-up se attivo
         if (adRefreshTimers.popup) {
            clearTimeout(adRefreshTimers.popup);
        }
    }
    
    // Funzione per mostrare gli annunci (dopo aver verificato lo stato)
    function showAdsIfEnabled() {
        if (isAdsEnabled()) {
            startAdsListener(); // Ri-attiva il listener e la visualizzazione
             // Ri-attiva i contenitori desktop se in modalitÃ  desktop
             if (window.innerWidth >= 768) {
                  document.getElementById('leftAdContainer').classList.remove('hidden-ads');
                  document.getElementById('rightAdContainer').classList.remove('hidden-ads');
             }
        } else {
            hideAllAds(); // Nasconde gli annunci se attivi
            // Aggiorna il messaggio del bottone se l'admin lo richiede
            const remaining = Math.ceil((adsRemovedExpiry - new Date()) / (1000 * 3600 * 24));
            document.getElementById('removeAdsBtn').textContent = `ADS OFF: ${remaining} giorni`;
            document.getElementById('removeAdsBtn').disabled = true;
        }
    }


    // --- 4. Elementi DOM Ads ---
    const elements = {
        sticky: {
            banner: document.getElementById('stickyAdBanner'),
            link: document.getElementById('stickyAdLink'),
            title: document.getElementById('stickyAdTitle'),
            desc: document.getElementById('stickyAdDescription'),
            controls: document.getElementById('stickyAdControls'),
            back: document.getElementById('stickyAdBackArrow'),
            infoCont: document.getElementById('stickyAdInfoTextContainer'),
            image: document.getElementById('stickyAdImage'), 
            contentDiv: document.getElementById('stickyAdContent'),
        },
        inline: {
            banner: document.getElementById('inlineAdBanner'),
            link: document.getElementById('inlineAdLink'),
            title: document.getElementById('inlineAdTitle'),
            desc: document.getElementById('inlineAdDescription'),
            controls: document.getElementById('inlineAdControls'),
            back: document.getElementById('inlineAdBackArrow'),
            infoCont: document.getElementById('inlineAdInfoTextContainer'),
            image: document.getElementById('inlineAdImage'), 
            contentDiv: document.getElementById('inlineAdContent'), 
        },
        middle: { 
            banner: document.getElementById('middleAdBanner'),
            link: document.getElementById('middleAdLink'),
            title: document.getElementById('middleAdTitle'),
            desc: document.getElementById('middleAdDescription'),
            controls: document.getElementById('middleAdControls'),
            back: document.getElementById('middleAdBackArrow'),
            infoCont: document.getElementById('middleAdInfoTextContainer'),
            image: document.getElementById('middleAdImage'), 
            contentDiv: document.getElementById('middleAdContent'), 
        },
        popup: { 
            banner: document.getElementById('popupAdBanner'),
            link: document.getElementById('popupAdLink'),
            title: document.getElementById('popupAdTitle'),
            desc: document.getElementById('popupAdDescription'),
            controls: document.getElementById('popupAdControls'),
            back: document.getElementById('popupAdBackArrow'),
            infoCont: document.getElementById('popupAdInfoTextContainer'),
            image: document.getElementById('popupAdImage'), 
            contentDiv: document.getElementById('popupAdContent'), 
        }
    };
    
    // Aggiungi gli elementi del Bottom Sheet
    const removeAdsBtn = document.getElementById('removeAdsBtn');
    const bottomSheetModal = document.getElementById('bottomSheetModal');
    const overlay = document.getElementById('overlay');
    const adsRemovalKeyInput = document.getElementById('adsRemovalKeyInput');
    const validateKeyBtn = document.getElementById('validateKeyBtn');
    const validationMessage = document.getElementById('validationMessage');


    // --- 5. Logica Annunci (Modificata per isAdsEnabled) ---
    
    function getRandomAd(type) {
        if (allAds.length === 0) return null;
        const currentAdId = currentAd[type]?.id;
        
        let availableAds = allAds.filter(ad => ad.id !== currentAdId);
        
        if (availableAds.length === 0) {
            availableAds = allAds;
        }

        return availableAds[Math.floor(Math.random() * availableAds.length)];
    }
    
    function setupRandomRefreshTimer(type) {
         if (!isAdsEnabled()) return; // Non impostare timer se gli annunci sono disattivati
        
        if (adRefreshTimers[type]) {
            clearTimeout(adRefreshTimers[type]);
        }
        
        const minDuration = 20000;
        const maxDuration = 60000;
        const randomTime = Math.floor(Math.random() * (maxDuration - minDuration + 1)) + minDuration;
        
        adRefreshTimers[type] = setTimeout(() => {
            displayBannerAd(type, true); 
            setupRandomRefreshTimer(type); 
        }, randomTime);
    }
    
    function setupPopupCycle() {
        if (!isAdsEnabled()) return; // Non avviare ciclo se gli annunci sono disattivati
        
        const type = 'popup';
        const el = elements[type];
        
        if (adRefreshTimers[type]) {
            clearTimeout(adRefreshTimers[type]);
        }
        
        const displayDuration = Math.floor(Math.random() * (15000 - 10000 + 1)) + 10000;
        const hiddenDuration = Math.floor(Math.random() * 5000); 

        displayBannerAd(type, true); 
        el.banner.style.display = 'flex';
        setTimeout(() => {
            el.banner.classList.remove('hide');
            el.banner.classList.add('show');
        }, 50); 

        adRefreshTimers[type] = setTimeout(() => {
            el.banner.classList.remove('show');
            el.banner.classList.add('hide');
            
            setTimeout(() => {
                el.banner.style.display = 'none';
                setupPopupCycle();
            }, 500 + hiddenDuration); 
            
        }, displayDuration);
    }


    function displayBannerAd(type, forceNewAd = false) {
        if (!isAdsEnabled()) return; // Non visualizzare se disattivati
        
        let ad;
        if (forceNewAd) {
            ad = getRandomAd(type); 
        } else {
            ad = currentAd[type] || getRandomAd(type); 
        }
        
        const el = elements[type];

        if (!el || !ad) {
            if (el) el.banner.style.display = 'none';
            return;
        }
        
        currentAd[type] = ad;
        
        el.link.href = ad.link; 
        el.link.classList.remove('hidden-content');
        el.infoCont.style.display = 'none';
        el.back.style.display = 'none';
        el.controls.style.display = 'flex';
        
        if (type !== 'popup') {
            if (el.banner.style.display !== 'flex' && type !== 'popup') {
                 setupRandomRefreshTimer(type);
            }
             el.banner.style.display = 'flex'; 
        }

        // Reset Immagine/Testo
        if (el.image && el.contentDiv) {
             el.image.style.display = 'none';
             el.contentDiv.style.display = 'flex';
             el.image.src = ''; 
             el.banner.classList.remove('image-ad'); 
        }
        
        // Logica specifica per tipo di banner
        if (type === 'sticky') {
             el.banner.style.padding = '5px 0'; 
            if (ad.type === 'image' && ad.bannerImageUrl) {
                el.image.src = ad.bannerImageUrl;
                el.image.style.display = 'block'; 
                el.contentDiv.style.display = 'none'; 
                el.banner.classList.add('image-ad'); 
                el.banner.style.padding = '0';
            } else {
                el.title.textContent = ad.title || 'Annuncio';
                el.desc.textContent = ad.description || ad.link;
                el.contentDiv.style.display = 'flex';
            }
        } else { 
            el.banner.style.padding = '5px';
            if (ad.type === 'image' && ad.imageUrl) {
                el.image.src = ad.imageUrl;
                el.image.style.display = 'block'; 
                el.contentDiv.style.display = 'none'; 
                el.banner.classList.add('image-ad'); 
                el.banner.style.padding = '0';
            } else {
                el.title.textContent = ad.title || 'Annuncio Testo';
                el.desc.textContent = ad.description || ad.link;
                el.contentDiv.style.display = 'flex';
            }
        }
        
         // Aggiornamento per la modalitÃ  desktop
        if (window.innerWidth >= 768 && (type === 'inline' || type === 'middle')) {
             // In modalitÃ  desktop, gli annunci inline e middle sono clonati nei contenitori laterali.
             const isMiddle = type === 'middle';
             const destEl = isMiddle ? document.getElementById('leftAdContainer') : document.getElementById('rightAdContainer');
             
             // Clonazione superficiale (solo il banner) e inserimento nel contenitore laterale
             let clonedBanner = destEl.querySelector('.ad-banner');
             if (!clonedBanner) {
                 clonedBanner = el.banner.cloneNode(true); // Cloniamo la struttura
                 clonedBanner.id = type + 'AdBannerDesktop'; // ID per evitare duplicati
                 // Rimuoviamo gli elementi che non servono nel clone se necessario
                 clonedBanner.querySelector('.ad-controls').style.display = 'none'; 
                 clonedBanner.querySelector('.ad-back-arrow').style.display = 'none';
                 destEl.appendChild(clonedBanner);
             }
             
             // Aggiorniamo il contenuto del clone
             const clonedTitle = clonedBanner.querySelector('.ad-title');
             const clonedDesc = clonedBanner.querySelector('.ad-description');
             const clonedLink = clonedBanner.querySelector('.ad-link-wrapper');
             const clonedImage = clonedBanner.querySelector('.ad-image');
             const clonedContentDiv = clonedBanner.querySelector('.ad-content');

             clonedLink.href = ad.link;
             clonedBanner.style.display = 'flex';
             
             if (ad.type === 'image' && ad.imageUrl) {
                 clonedImage.src = ad.imageUrl;
                 clonedImage.style.display = 'block'; 
                 clonedContentDiv.style.display = 'none'; 
                 clonedBanner.classList.add('image-ad'); 
                 clonedBanner.style.padding = '0';
             } else {
                 clonedTitle.textContent = ad.title || 'Annuncio Testo';
                 clonedDesc.textContent = ad.description || ad.link;
                 clonedImage.style.display = 'none';
                 clonedContentDiv.style.display = 'flex'; 
                 clonedBanner.classList.remove('image-ad');
                 clonedBanner.style.padding = '5px';
             }
             
             // Nascondiamo gli originali nel flusso del contenuto
             el.banner.style.display = 'none';
             
             // Rimuoviamo la classe hidden-ads
             destEl.classList.remove('hidden-ads');
        } else if (window.innerWidth >= 768 && (type === 'inline' || type === 'middle')) {
            // Se in desktop mode e non ci sono annunci validi, nascondi i contenitori
             document.getElementById('leftAdContainer').classList.add('hidden-ads');
             document.getElementById('rightAdContainer').classList.add('hidden-ads');
        }
    }

    window.toggleAdInfoView = (type, showInfo = true) => {
        const el = elements[type];
        if (showInfo) {
            el.link.classList.add('hidden-content');
            el.controls.style.display = 'none';
            el.infoCont.style.display = 'flex';
            el.back.style.display = 'block'; 
            
            if (adRefreshTimers[type] && type !== 'popup') {
                clearTimeout(adRefreshTimers[type]);
            }
        } else {
            el.link.classList.remove('hidden-content');
            el.controls.style.display = 'flex';
            el.infoCont.style.display = 'none';
            el.back.style.display = 'none';
            
            if (type !== 'popup' && isAdsEnabled()) {
                setupRandomRefreshTimer(type);
            }
        }
    };
    
    elements.sticky.back.onclick = () => { window.toggleAdInfoView('sticky', false); };
    elements.inline.back.onclick = () => { window.toggleAdInfoView('inline', false); };
    elements.middle.back.onclick = () => { window.toggleAdInfoView('middle', false); }; 
    elements.popup.back.onclick = () => { window.toggleAdInfoView('popup', false); }; 

    function startAdsListener() {
        if (!isAdsEnabled()) {
             hideAllAds();
             return;
        }
        
        if (adsUnsubscribe) adsUnsubscribe(); 
        const adsQuery = query(collection(db, ADS_COLLECTION_PATH));
        adsUnsubscribe = onSnapshot(adsQuery, (snapshot) => {
            allAds = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.imageUrl || data.bannerImageUrl || data.title || data.description) {
                     allAds.push({ id: doc.id, ...data });
                }
            });
            
            if (isAdsEnabled()) {
                displayBannerAd('sticky', true);
                displayBannerAd('inline', true);
                displayBannerAd('middle', true); 
                setupPopupCycle();
            } else {
                hideAllAds();
            }
            
        }, (error) => {
             console.error("Errore ads:", error);
             Object.values(elements).forEach(el => {
                if(el.banner) el.banner.style.display = 'none';
             });
        });
    }

    async function initFirebase() {
        setLogLevel('Silent'); 
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            
            showAdsIfEnabled(); // Controllo iniziale dello stato annunci
            
        } catch (error) { 
            console.error("Errore init Firebase:", error); 
        }
    }
    
    // Inizializza tutto all'avvio
    initFirebase();
    
    // --- 6. LOGICA CHAT (MANTENUTA INVARIATA) ---
    const aiFab = document.getElementById('ai-fab');
    const chatModal = document.getElementById('chat-modal');
    const closeChatBtn = document.getElementById('chat-close-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('chat-send-btn');
    
    const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1445514283726405651/lQTiNHR3bCDw6sNmRIZTiqZOyQPz3RW16Rn-Dgm7EOf2BbBAy8I7rCm9DKJxB6BIgpDx";
    let chatStep = 0; 
    let collabData = {
        channelInfo: "", riesi: "", collabTopic: "", knowsOwner: "", channelName: "", phone: ""
    };
    const badWords = ["uccidere", "morire", "odio", "stupido", "scemo", "truffa", "droga", "armi", "porno", "sex", "violenza"];

    aiFab.addEventListener('click', () => {
        chatModal.style.display = 'flex';
        if (chatMessages.children.length === 0) {
            addMessage("ai", "Ciao! Scrivi 'Voglio collaborare' per iniziare.");
        }
    });

    closeChatBtn.addEventListener('click', () => { chatModal.style.display = 'none'; });
    function addMessage(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender);
        msgDiv.textContent = text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    function isBadContent(text) {
        const lower = text.toLowerCase();
        return badWords.some(word => lower.includes(word));
    }
    function sendToDiscord() {
        const payload = {
            content: "ðŸš€ **Nuova Richiesta Collaborazione!**",
            embeds: [{
                title: "Dettagli Candidato",
                color: 5814783, 
                fields: [
                    { name: "Canale/Base", value: collabData.channelInfo || "N/A" },
                    { name: "Abita a Riesi?", value: collabData.riesi || "N/A" },
                    { name: "Idea Collab", value: collabData.collabTopic || "N/A" },
                    { name: "Conosce Proprietario?", value: collabData.knowsOwner || "N/A" },
                    { name: "Nome Canale", value: collabData.channelName || "N/A" },
                    { name: "Telefono", value: collabData.phone || "N/A" }
                ],
                footer: { text: "La Gang dei Richiardi Bot" }
            }]
        };
        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(res => console.log("Inviato a Discord", res))
          .catch(err => console.error("Errore invio Discord", err));
    }

    function handleChatLogic(userText) {
        const lowerText = userText.toLowerCase();
        // ... (Logica chat invariata) ...
        if (chatStep === 0) {
            if (lowerText.includes("voglio collaborare")) {
                addMessage("ai", "Certo dimmi il nome del tuo canale, su cosa e basato.");
                chatStep = 1;
            } else {
                addMessage("ai", "Per favore scrivi 'Voglio collaborare' per iniziare la procedura.");
            }
            return;
        }

        if (chatStep === 1) {
            collabData.channelInfo = userText;
            addMessage("ai", "Ok! Un' altra domanda, abiti a Riesi?");
            chatStep = 2;
            return;
        }

        if (chatStep === 2) {
            if (lowerText.includes("si") || lowerText.includes("sÃ¬")) {
                collabData.riesi = "Si";
                addMessage("ai", "Perfetto! Ci siamo quasi, stiamo per finire! Su cosa sarÃ  basata la tua collab??");
                chatStep = 3;
            } else {
                addMessage("ai", "Mi dispiace, cerchiamo collaboratori in zona. La chat termina qui.");
                chatStep = 99;
            }
            return;
        }

        if (chatStep === 3) {
            if (isBadContent(userText)) {
                addMessage("ai", "La tua proposta non rispetta le nostre linee guida. La chat termina qui.");
                chatStep = 99;
            } else {
                collabData.collabTopic = userText;
                addMessage("ai", "Ok! Ultima domanda, conosci il proprietario del canale dei richiardi?");
                chatStep = 4;
            }
            return;
        }

        if (chatStep === 4) {
            if (lowerText.includes("si") || lowerText.includes("sÃ¬")) {
                collabData.knowsOwner = "Si";
                addMessage("ai", "Ok, la tua collab Ã¨ stata inviata al proprietario dei richiardi, dimmi solo il nome del canale");
                chatStep = 5;
            } else {
                addMessage("ai", "Ci dispiace, preferiamo collaborare con chi ci conosce giÃ . La chat termina qui.");
                chatStep = 99;
            }
            return;
        }

        if (chatStep === 5) {
            collabData.channelName = userText;
            addMessage("ai", "Dimmi Il Tuo numero di telefono");
            chatStep = 6;
            return;
        }

        if (chatStep === 6) {
            const phoneRegex = /[0-9]{9,}/;
            if (phoneRegex.test(userText.replace(/\s/g, ''))) {
                collabData.phone = userText;
                addMessage("ai", "Perfetto chat finita. Un'admin ti contatterÃ  al piÃ¹ presto possibile");
                sendToDiscord();
                chatStep = 99;
            } else {
                addMessage("ai", "Per favor inserisci un numero valido.");
            }
            return;
        }
    }

    function sendMessage() {
        const text = chatInput.value.trim();
        if (!text) return;

        addMessage("user", text);
        chatInput.value = "";
        
        setTimeout(() => {
            handleChatLogic(text);
        }, 800);
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    // --- 7. LOGICA RIMOZIONE ANNUNCI (Nuova) ---

    function showBottomSheet() {
        if (adsRemovedExpiry && adsRemovedExpiry > new Date()) {
             const remaining = Math.ceil((adsRemovedExpiry - new Date()) / (1000 * 3600 * 24));
             validationMessage.style.color = 'var(--secondary)';
             validationMessage.textContent = `Annunci giÃ  rimossi! Scadenza tra ${remaining} giorni.`;
             adsRemovalKeyInput.value = '';
             validateKeyBtn.disabled = true;
        } else {
             validationMessage.textContent = '';
             validateKeyBtn.disabled = false;
        }
        bottomSheetModal.style.display = 'flex';
        overlay.style.display = 'block';
        setTimeout(() => {
            bottomSheetModal.classList.add('visible');
        }, 10);
    }

    function hideBottomSheet() {
        bottomSheetModal.classList.remove('visible');
        setTimeout(() => {
            bottomSheetModal.style.display = 'none';
            overlay.style.display = 'none';
        }, 300); 
    }
    
    // Nasconde il bottom sheet quando si clicca sull'overlay
    overlay.addEventListener('click', hideBottomSheet);

    removeAdsBtn.addEventListener('click', showBottomSheet);
    
    // Funzione di validazione chiave lato client (SIMULATA)
    validateKeyBtn.addEventListener('click', () => {
        const key = adsRemovalKeyInput.value.trim().toUpperCase();
        
        // Formato chiave atteso: [DURATA_INIZIALE]-[DURATA_FINALE]-[HASH]
        const keyRegex = /^(\d+[D])-\d+[D]-([A-Z0-9+=/]{8,})$/; 
        const match = key.match(keyRegex);

        if (key.length === 0) {
            validationMessage.style.color = 'var(--primary)';
            validationMessage.textContent = 'Inserisci una chiave.';
            return;
        }
        
        if (!match) {
            validationMessage.style.color = 'var(--primary)';
            validationMessage.textContent = 'Chiave non valida. Formato errato.';
            return;
        }
        
        const durationStr = match[1]; // Es. "7D"
        const durationMap = {
            '24H': 1, '3D': 3, '7D': 7, '14D': 14
        };
        const days = durationMap[durationStr];
        
        if (!days) {
            validationMessage.style.color = 'var(--primary)';
            validationMessage.textContent = 'Durata non riconosciuta nella chiave.';
            return;
        }
        
        // Simula la verifica dell'unicitÃ /integritÃ 
        // Per l'ambiente client-only, si considera una chiave valida se ha il formato corretto.
        // In una vera applicazione, la chiave verrebbe inviata a un server.
        
        // Inizializza la data di scadenza
        const expiryDate = new Date();
        expiryDate.setDate(expiryDate.getDate() + days);

        // 1. Salva lo stato in Local Storage
        localStorage.setItem(ADS_EXPIRY_KEY, expiryDate.toISOString());
        adsRemovedExpiry = expiryDate;

        // 2. Aggiorna lo stato dell'UI
        hideAllAds();
        document.body.classList.remove('ads-enabled');
        document.body.classList.add('ads-removed');
        
        const remaining = Math.ceil((adsRemovedExpiry - new Date()) / (1000 * 3600 * 24));
        document.getElementById('removeAdsBtn').textContent = `ADS OFF: ${remaining} giorni`;
        document.getElementById('removeAdsBtn').disabled = true;

        // 3. Feedback e chiusura
        validationMessage.style.color = 'var(--secondary)';
        validationMessage.textContent = `Successo! Annunci rimossi per ${days} giorni.`;
        validateKeyBtn.disabled = true;
        
        setTimeout(() => {
            hideBottomSheet();
        }, 2000);
    });
    
    // --- Logica Desktop (Risposta a resize) ---
    function handleDesktopView() {
        const isDesktop = window.innerWidth >= 768;
        const leftAdContainer = document.getElementById('leftAdContainer');
        const rightAdContainer = document.getElementById('rightAdContainer');

        if (isDesktop && isAdsEnabled()) {
             // Forziamo il refresh degli annunci per popolarli nei contenitori laterali
             displayBannerAd('middle', true);
             displayBannerAd('inline', true);
             leftAdContainer.classList.remove('hidden-ads');
             rightAdContainer.classList.remove('hidden-ads');
        } else if (isDesktop && !isAdsEnabled()) {
             // Se annunci rimossi, nascondi i contenitori laterali anche se siamo in desktop
             leftAdContainer.classList.add('hidden-ads');
             rightAdContainer.classList.add('hidden-ads');
        } else if (!isDesktop && isAdsEnabled()) {
             // In mobile/tablet, assicurati che gli originali siano visibili
             elements.inline.banner.style.display = 'flex';
             elements.middle.banner.style.display = 'flex';
             leftAdContainer.classList.add('hidden-ads');
             rightAdContainer.classList.add('hidden-ads');
        }
    }

    // Listener di resize per l'adattamento desktop
    window.addEventListener('resize', handleDesktopView);
    // Controllo iniziale al caricamento
    handleDesktopView();


</script>

</body>
</html>
